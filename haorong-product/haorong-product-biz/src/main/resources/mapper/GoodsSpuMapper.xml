<?xml version="1.0" encoding="UTF-8" ?>
<!-- 
  Copyright (c) 2025 沈阳浩荣科技有限公司 
  All rights reserved. 
  注意： 
  本项目源代码由沈阳浩荣科技有限公司原创开发，版权所有。 
 -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.haorong.cloud.product.mapper.GoodsSpuMapper">
    <resultMap id="goodsSpuMap" type="com.haorong.cloud.product.api.entity.GoodsSpu">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <collection property="goodsSpuSpecs" column="{spuId=id}"
                    ofType="com.haorong.cloud.product.api.entity.GoodsSpecs"
                    select="com.haorong.cloud.product.mapper.GoodsSpuSpecsMapper.selectBySpuId"></collection>
        <collection property="goodsSkus" column="{spuId=id}"
                    ofType="com.haorong.cloud.product.api.entity.GoodsSku"
                    select="com.haorong.cloud.product.mapper.GoodsSkuMapper.selectBySpuId"></collection>
    </resultMap>

    <resultMap id="resultMap2" type="com.haorong.cloud.product.api.entity.GoodsSpu">
        <collection property="goodsSkus" column="{spuId=id}"
                    ofType="com.haorong.cloud.product.api.entity.GoodsSku"
                    select="com.haorong.cloud.product.mapper.GoodsSkuMapper.selectBySpuId"></collection>
        <collection property="goodsSpuSpecs" column="{spuId=id}"
                    ofType="com.haorong.cloud.product.api.entity.GoodsSpuSpecs"
                    select="com.haorong.cloud.product.mapper.GoodsSpuSpecsMapper.selectListBySpuId2"></collection>
    </resultMap>

    <sql id="goodsSpuSql">
        goods_spu
        .
        id
        ,
        goods_spu.`name`,
        goods_spu.sub_title,
        goods_spu.spu_urls,
        goods_spu.`status`,
        goods_spu.sales_volume,
        goods_spu.category_first_id,
        goods_spu.category_second_id,
        goods_spu.create_time,
        goods_spu.update_time,
        goods_spu.del_flag,
        goods_spu.description,
        goods_spu.enable_specs,
        goods_spu.stock,
        goods_spu.freight_type,
        goods_spu.fixed_freight_price,
        goods_spu.sales_price,
        goods_spu.original_price,
        goods_spu.cost_price
    </sql>
    <select id="selectPageByAdmin" resultType="com.haorong.cloud.product.api.entity.GoodsSpu">
        SELECT
        <include refid="goodsSpuSql"/>,
        goods_category.name AS categoryName
        FROM
        goods_spu AS goods_spu
        LEFT JOIN goods_category AS goods_category ON goods_spu.category_second_id = goods_category.id
        <where>
            AND goods_spu.`del_flag` = '0'
            <if test="query.name != null and query.name != ''">
                AND LOWER(goods_spu.`name`) LIKE CONCAT('%',LOWER(#{query.name}),'%')
            </if>
            <if test="query.status != null and query.status != ''">
                AND goods_spu.`status` = #{query.status}
            </if>
            <if test="query.categorySecondId != null and query.categorySecondId != ''">
                AND goods_category.`id` = #{query.categorySecondId}
            </if>
        </where>
    </select>
    <select id="selectPageWarehouse" resultType="com.haorong.cloud.product.api.entity.GoodsSpu">
        SELECT
        <include refid="goodsSpuSql"/>,
        goods_category.name AS categoryName
        FROM
        goods_spu AS goods_spu
        LEFT JOIN goods_category AS goods_category ON goods_spu.category_second_id = goods_category.id
        <where>
            AND goods_spu.`del_flag` = '0'
            <if test="query.name != null and query.name != ''">
                AND LOWER(goods_spu.`name`) LIKE CONCAT('%',LOWER(#{query.name}),'%')
            </if>
            <if test="query.status != null and query.status != ''">
                AND goods_spu.`status` = #{query.status}
            </if>
        </where>
    </select>

    <select id="selectSpuById" resultMap="goodsSpuMap">
        SELECT
        <include refid="goodsSpuSql"/>
        FROM
        goods_spu as `goods_spu`
        WHERE goods_spu.`id` =#{id} AND goods_spu.`del_flag` = '0'
    </select>

    <select id="selectApiPage" resultType="com.haorong.cloud.product.api.entity.GoodsSpu">
        SELECT
        <include refid="goodsSpuSql"/>,
        goods_category.name AS categoryName
        FROM
        goods_spu AS goods_spu
        LEFT JOIN goods_category AS goods_category ON goods_spu.category_second_id = goods_category.id
        <where>
            AND goods_spu.`del_flag` = '0'
            AND goods_category.`del_flag` = '0'
            AND goods_spu.`status` = '1'
            <if test="query.name != null and query.name != ''">
                AND LOWER(goods_spu.`name`) LIKE CONCAT('%',LOWER(#{query.name}),'%')
            </if>
            <if test="query.categoryFirstId != null and query.categoryFirstId != ''">
                AND goods_spu.`category_first_id` = #{query.categoryFirstId}
            </if>
            <if test="query.categorySecondId != null and query.categorySecondId != ''">
                AND goods_spu.`category_second_id` = #{query.categorySecondId}
            </if>

        </where>
    </select>
    <select id="selectSpuByShoppingCart" resultType="com.haorong.cloud.product.api.entity.GoodsSpu">
        SELECT
        <include refid="goodsSpuSql"/>
        FROM
        goods_spu AS goods_spu
        where goods_spu.id = #{id}
    </select>
    <select id="selectApiSpuById" resultMap="resultMap2">
        SELECT
        <include refid="goodsSpuSql"/>
        FROM
        goods_spu AS goods_spu
        where goods_spu.id = #{id}
        AND goods_spu.del_flag = '0'
        AND goods_spu.status = '1'
    </select>

</mapper>